import{_ as k,u as I,x as P,y as $,z as A,L as r,A as z,h as L,c as S,o as j,a as C}from"./index-wT4GQKR0.js";const T="/assets/new_delivery-icon-C29wNBXO.png",U="/assets/in_progress-icon-DNYzjzzQ.png",O={name:"MapComponent",setup(){const n=I(null),p=P(),a=$(()=>p.getters.getUserId),c=new Date,u=`${c.getFullYear()}-${`0${c.getMonth()+1}`.slice(-2)}-${`0${c.getDate()}`.slice(-2)}`;async function g(){navigator.geolocation.getCurrentPosition(async e=>{const t=e.coords.latitude,s=e.coords.longitude,o={courier_id:a.value,latitude:t,longitude:s};try{const i=await fetch("https://musorok.online:8000/courier_locations/",{method:"POST",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw new Error("Не удалось получить локацию курьера");console.log("отправил локацию",await i.json())}catch(i){console.error("Произошла ошибка отправки локации:",i)}})}A(()=>{m(),f(),g()});function f(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{const t=e.coords.latitude,s=e.coords.longitude,o=r.icon({iconUrl:z,iconSize:[40],iconAnchor:[16,32],popupAnchor:[0,-32]});n.value?(r.marker([t,s],{icon:o}).addTo(n.value).bindPopup("Вы здесь"),n.value.setView([t,s],13)):console.error("Карта не инициализирована")},e=>{console.error("Error getting user position:",e)}):console.error("Геолокация не поддерживается этим браузером.")}async function m(){console.log("User ID:",a.value);try{const e=await fetch(`https://musorok.online:8000/delivery_agent_orders/${a.value}`,{method:"POST",headers:{accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({order_date:u})});if(!e.ok){console.warn("Ошибка при отправке данных, код:",e.status),d();return}const t=await e.json();console.log("Данные из API:",t);let s=t.find(o=>o.latitude&&o.longitude&&o.meeting_status==="Waiting")||t.find(o=>o.latitude&&o.longitude);s?(n.value=r.map("map").setView([s.latitude,s.longitude],11),r.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(n.value),y(t)):(console.error("Нет доступных координат для инициализации карты"),d())}catch(e){console.error("Error loading points from API:",e),d()}}function d(){n.value=r.map("map").setView([55.7558,37.6173],11),r.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(n.value),console.log("Карта инициализирована с координатами по умолчанию")}function y(e){const t=r.icon({iconUrl:T,iconSize:[32],iconAnchor:[16,32],popupAnchor:[0,-32]}),s=r.icon({iconUrl:U,iconSize:[32],iconAnchor:[16,32],popupAnchor:[0,-32]});e.forEach(o=>{if(o.latitude&&o.longitude){const v=`<div style="position: relative; display: inline-block;">
                                <img src="${(o.meeting_status==="In progress"?t:s).options.iconUrl}" style="width: 32px;">
                                <div style="position: absolute; top: 6px; left: 39px; background-color: white; padding: 2px 5px; border: 1px solid white; border-radius: 5px; width: 90px; font-size: 14px; text-align: center;">
                                  ${o.interval}
                                  <div style="position: absolute; top: 9px; left: -8px; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 5px solid white; transform: rotate(90deg);"></div>
                                </div>
                              </div>`,w=r.divIcon({html:v,className:"custom-marker",iconSize:[32],iconAnchor:[16,32],popupAnchor:[0,-32]}),x=o.meeting_status==="Waiting"?`<p>${o.full_adress}</p><button :plain='true' class='add__delivery-btn' onclick="handleOrder('${o.id}', this)">взять в работу</button>`:`<p>${o.full_adress}</p>`;if(n.value){const h=r.marker([o.latitude,o.longitude],{icon:w}).addTo(n.value).bindPopup(x);h.on("popupopen",function(){window.handleOrder=async function(b){try{const l=await fetch("https://musorok.online:8000/update_delivery_in_progress/",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:String(b)})});if(!l.ok)throw new Error("Ошибка при отправке данных");console.log("Обновил статус: ",await l.json()),_(),h.setIcon(t),n.value.closePopup()}catch(l){console.error("Произошла ошибка: ",l)}}})}else console.error("Карта не инициализирована")}})}function _(){L({message:"Вы взялись за заказ!",type:"success"})}return{map:n}}},D={id:"map-container"},E=C("div",{id:"map"},null,-1),M=[E];function N(n,p,a,c,u,g){return j(),S("div",D,M)}const V=k(O,[["render",N]]);export{V as default};
